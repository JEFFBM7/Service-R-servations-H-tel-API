<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Réservations - Service Hôtel</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
</head>
<body>
    <header class="header">
        <h1>Réservations</h1>
        <nav class="nav">
            <a href="index.xhtml">Accueil</a>
            <a href="reservations.xhtml" class="active">Réservations</a>
            <a href="disponibilite.xhtml">Disponibilité</a>
            <a href="clients.xhtml">Clients</a>
            <a href="rapport.xhtml">Rapport</a>
        </nav>
    </header>
    <div class="container">
        <div id="message" class="message"></div>
        <div class="card">
            <div class="card-title">
                <span id="formTitle">Nouvelle réservation</span>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Réinitialiser</button>
            </div>
            <form id="reservationForm" action="#" method="post">
                <input type="hidden" id="reservationId" name="reservationId" value="" />
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientId">ID Client</label>
                        <input type="number" id="clientId" name="clientId" required="required" min="1" placeholder="1" />
                    </div>
                    <div class="form-group">
                        <label for="chambreId">ID Chambre</label>
                        <input type="number" id="chambreId" name="chambreId" required="required" min="1" placeholder="101" />
                    </div>
                    <div class="form-group">
                        <label for="dateDebut">Date d'arrivée</label>
                        <input type="date" id="dateDebut" name="dateDebut" required="required" />
                    </div>
                    <div class="form-group">
                        <label for="dateFin">Date de départ</label>
                        <input type="date" id="dateFin" name="dateFin" required="required" />
                    </div>
                    <div class="form-group full">
                        <label for="remarques">Remarques</label>
                        <textarea id="remarques" name="remarques" rows="2" placeholder="Remarques optionnelles..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Créer</button>
                </div>
            </form>
        </div>
        <div class="card">
            <div class="card-title">Liste des réservations</div>
            <div class="filters">
                <div class="form-group">
                    <select id="filterStatut" name="filterStatut">
                        <option value="">Tous les statuts</option>
                        <option value="EN_ATTENTE">En attente</option>
                        <option value="CONFIRMEE">Confirmée</option>
                        <option value="EN_COURS">En cours</option>
                        <option value="TERMINEE">Terminée</option>
                        <option value="ANNULEE">Annulée</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" id="filterClientId" name="filterClientId" placeholder="Filtrer par client ID" />
                </div>
                <button type="button" class="btn btn-secondary" onclick="chargerReservations()">Filtrer</button>
            </div>
            <div id="reservationsList">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Chambre</th>
                            <th>Arrivée</th>
                            <th>Départ</th>
                            <th>Statut</th>
                            <th>Montant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script type="text/javascript">
    //<![CDATA[
        const API_BASE = 'api/reservations';
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDebut').min = today;
            document.getElementById('dateFin').min = today;
            chargerReservations();
            document.getElementById('reservationForm').addEventListener('submit', function(e) { e.preventDefault(); sauvegarderReservation(); });
            document.getElementById('filterStatut').addEventListener('change', chargerReservations);
        });
        function afficherMessage(texte, type) { var msg = document.getElementById('message'); msg.textContent = texte; msg.className = 'message ' + type; msg.style.display = 'block'; setTimeout(function() { msg.style.display = 'none'; }, 4000); }
        function getStatutBadge(statut) { var classes = {'EN_ATTENTE':'badge-pending','CONFIRMEE':'badge-confirmed','EN_COURS':'badge-active','TERMINEE':'badge-completed','ANNULEE':'badge-cancelled'}; return '<span class="badge ' + (classes[statut] || '') + '">' + statut + '</span>'; }
        async function chargerReservations() {
            var tbody = document.getElementById('reservationsTableBody');
            try {
                var url = API_BASE;
                var statut = document.getElementById('filterStatut').value;
                var clientId = document.getElementById('filterClientId').value;
                if (clientId) url += '?clientId=' + clientId;
                else if (statut) url += '?statut=' + statut;
                var response = await fetch(url);
                var data = await response.json();
                if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="empty">Aucune réservation</td></tr>'; }
                else { 
                    var html = '';
                    for (var i = 0; i < data.length; i++) {
                        var r = data[i];
                        html += '<tr><td>#' + r.id + '</td><td>' + (r.nomClient || 'Client ' + r.clientId) + '</td><td>' + (r.numeroChambre || r.chambreId) + '</td><td>' + r.dateDebut + '</td><td>' + r.dateFin + '</td><td>' + getStatutBadge(r.statut) + '</td><td>' + (r.montantTotal ? r.montantTotal.toFixed(2) + ' €' : '—') + '</td><td><button class="btn btn-secondary action-btn" onclick="modifier(' + r.id + ')">Modifier</button>';
                        if (r.statut === 'EN_ATTENTE') html += '<button class="btn btn-success action-btn" onclick="confirmer(' + r.id + ')">Confirmer</button>';
                        if (r.statut === 'CONFIRMEE') html += '<button class="btn btn-success action-btn" onclick="checkIn(' + r.id + ')">Check-in</button>';
                        if (r.statut === 'EN_COURS') html += '<button class="btn btn-secondary action-btn" onclick="checkOut(' + r.id + ')">Check-out</button>';
                        if (r.statut === 'EN_ATTENTE' || r.statut === 'CONFIRMEE') html += '<button class="btn btn-danger action-btn" onclick="annuler(' + r.id + ')">Annuler</button>';
                        html += '</td></tr>';
                    }
                    tbody.innerHTML = html;
                }
            } catch (e) { afficherMessage('Erreur de chargement', 'error'); }
        }
        async function sauvegarderReservation() {
            var id = document.getElementById('reservationId').value;
            var data = { clientId: parseInt(document.getElementById('clientId').value), chambreId: parseInt(document.getElementById('chambreId').value), dateDebut: document.getElementById('dateDebut').value, dateFin: document.getElementById('dateFin').value, remarques: document.getElementById('remarques').value };
            try {
                var response = await fetch(id ? API_BASE + '/' + id : API_BASE, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) { afficherMessage(id ? 'Réservation modifiée' : 'Réservation créée', 'success'); resetForm(); chargerReservations(); }
                else { var err = await response.json(); afficherMessage(err.message, 'error'); }
            } catch (e) { afficherMessage('Erreur', 'error'); }
        }
        async function modifier(id) { var response = await fetch(API_BASE + '/' + id); if (response.ok) { var r = await response.json(); document.getElementById('reservationId').value = r.id; document.getElementById('clientId').value = r.clientId; document.getElementById('chambreId').value = r.chambreId; document.getElementById('dateDebut').value = r.dateDebut; document.getElementById('dateFin').value = r.dateFin; document.getElementById('remarques').value = r.remarques || ''; document.getElementById('formTitle').textContent = 'Modifier réservation #' + id; document.getElementById('submitBtn').textContent = 'Modifier'; window.scrollTo({ top: 0, behavior: 'smooth' }); } }
        async function annuler(id) { if (!confirm('Annuler cette réservation ?')) return; var response = await fetch(API_BASE + '/' + id, { method: 'DELETE' }); if (response.ok) { afficherMessage('Réservation annulée', 'success'); chargerReservations(); } }
        async function confirmer(id) { var response = await fetch(API_BASE + '/' + id + '/confirmer', { method: 'POST' }); if (response.ok) { afficherMessage('Réservation confirmée', 'success'); chargerReservations(); } }
        async function checkIn(id) { var response = await fetch(API_BASE + '/' + id + '/checkin', { method: 'POST' }); if (response.ok) { afficherMessage('Check-in effectué', 'success'); chargerReservations(); } }
        async function checkOut(id) { var response = await fetch(API_BASE + '/' + id + '/checkout', { method: 'POST' }); if (response.ok) { afficherMessage('Check-out effectué', 'success'); chargerReservations(); } }
        function resetForm() { document.getElementById('reservationForm').reset(); document.getElementById('reservationId').value = ''; document.getElementById('formTitle').textContent = 'Nouvelle réservation'; document.getElementById('submitBtn').textContent = 'Créer'; }
    //]]>
    </script>
</body>
</html>
