<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservations - Service Hôtel</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="header">
        <h1>Réservations</h1>
        <nav class="nav">
            <a href="index.html">Accueil</a>
            <a href="reservations.html" class="active">Réservations</a>
            <a href="disponibilite.html">Disponibilité</a>
            <a href="clients.html">Clients</a>
            <a href="rapport.html">Rapport</a>
        </nav>
    </header>
    <div class="container">
        <div id="message" class="message"></div>
        <div class="card">
            <div class="card-title"><span id="formTitle">Nouvelle réservation</span><button class="btn btn-secondary" onclick="resetForm()">Réinitialiser</button></div>
            <form id="reservationForm">
                <input type="hidden" id="reservationId">
                <div class="form-grid">
                    <div class="form-group"><label>ID Client</label><input type="number" id="clientId" required min="1" placeholder="1"></div>
                    <div class="form-group"><label>ID Chambre</label><input type="number" id="chambreId" required min="1" placeholder="101"></div>
                    <div class="form-group"><label>Date d'arrivée</label><input type="date" id="dateDebut" required></div>
                    <div class="form-group"><label>Date de départ</label><input type="date" id="dateFin" required></div>
                    <div class="form-group full"><label>Remarques</label><textarea id="remarques" rows="2" placeholder="Remarques optionnelles..."></textarea></div>
                </div>
                <div class="btn-group"><button type="submit" class="btn btn-primary" id="submitBtn">Créer</button></div>
            </form>
        </div>
        <div class="card">
            <div class="card-title">Liste des réservations</div>
            <div class="filters">
                <div class="form-group"><select id="filterStatut"><option value="">Tous les statuts</option><option value="EN_ATTENTE">En attente</option><option value="CONFIRMEE">Confirmée</option><option value="EN_COURS">En cours</option><option value="TERMINEE">Terminée</option><option value="ANNULEE">Annulée</option></select></div>
                <div class="form-group"><input type="number" id="filterClientId" placeholder="Filtrer par client ID"></div>
                <button class="btn btn-secondary" onclick="chargerReservations()">Filtrer</button>
            </div>
            <div id="reservationsList"><table><thead><tr><th>ID</th><th>Client</th><th>Chambre</th><th>Arrivée</th><th>Départ</th><th>Statut</th><th>Montant</th><th>Actions</th></tr></thead><tbody id="reservationsTableBody"></tbody></table></div>
        </div>
    </div>
    <script>
        const API_BASE = 'api/reservations';
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDebut').min = today;
            document.getElementById('dateFin').min = today;
            chargerReservations();
            document.getElementById('reservationForm').addEventListener('submit', function(e) { e.preventDefault(); sauvegarderReservation(); });
            document.getElementById('filterStatut').addEventListener('change', chargerReservations);
        });
        function afficherMessage(texte, type) { const msg = document.getElementById('message'); msg.textContent = texte; msg.className = 'message ' + type; msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 4000); }
        function getStatutBadge(statut) { const classes = {'EN_ATTENTE':'badge-pending','CONFIRMEE':'badge-confirmed','EN_COURS':'badge-active','TERMINEE':'badge-completed','ANNULEE':'badge-cancelled'}; return `<span class="badge ${classes[statut] || ''}">${statut}</span>`; }
        async function chargerReservations() {
            const tbody = document.getElementById('reservationsTableBody');
            try {
                let url = API_BASE;
                const statut = document.getElementById('filterStatut').value;
                const clientId = document.getElementById('filterClientId').value;
                if (clientId) url += '?clientId=' + clientId;
                else if (statut) url += '?statut=' + statut;
                const response = await fetch(url);
                const data = await response.json();
                if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="empty">Aucune réservation</td></tr>'; }
                else { tbody.innerHTML = data.map(r => `<tr><td>#${r.id}</td><td>${r.nomClient || 'Client ' + r.clientId}</td><td>${r.numeroChambre || r.chambreId}</td><td>${r.dateDebut}</td><td>${r.dateFin}</td><td>${getStatutBadge(r.statut)}</td><td>${r.montantTotal ? r.montantTotal.toFixed(2) + ' €' : '—'}</td><td><button class="btn btn-secondary action-btn" onclick="modifier(${r.id})">Modifier</button>${r.statut === 'EN_ATTENTE' ? `<button class="btn btn-success action-btn" onclick="confirmer(${r.id})">Confirmer</button>` : ''}${r.statut === 'CONFIRMEE' ? `<button class="btn btn-success action-btn" onclick="checkIn(${r.id})">Check-in</button>` : ''}${r.statut === 'EN_COURS' ? `<button class="btn btn-secondary action-btn" onclick="checkOut(${r.id})">Check-out</button>` : ''}${['EN_ATTENTE', 'CONFIRMEE'].includes(r.statut) ? `<button class="btn btn-danger action-btn" onclick="annuler(${r.id})">Annuler</button>` : ''}</td></tr>`).join(''); }
            } catch (e) { afficherMessage('Erreur de chargement', 'error'); }
        }
        async function sauvegarderReservation() {
            const id = document.getElementById('reservationId').value;
            const data = { clientId: parseInt(document.getElementById('clientId').value), chambreId: parseInt(document.getElementById('chambreId').value), dateDebut: document.getElementById('dateDebut').value, dateFin: document.getElementById('dateFin').value, remarques: document.getElementById('remarques').value };
            try {
                const response = await fetch(id ? `${API_BASE}/${id}` : API_BASE, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) { afficherMessage(id ? 'Réservation modifiée' : 'Réservation créée', 'success'); resetForm(); chargerReservations(); }
                else { const err = await response.json(); afficherMessage(err.message, 'error'); }
            } catch (e) { afficherMessage('Erreur', 'error'); }
        }
        async function modifier(id) { const response = await fetch(`${API_BASE}/${id}`); if (response.ok) { const r = await response.json(); document.getElementById('reservationId').value = r.id; document.getElementById('clientId').value = r.clientId; document.getElementById('chambreId').value = r.chambreId; document.getElementById('dateDebut').value = r.dateDebut; document.getElementById('dateFin').value = r.dateFin; document.getElementById('remarques').value = r.remarques || ''; document.getElementById('formTitle').textContent = 'Modifier réservation #' + id; document.getElementById('submitBtn').textContent = 'Modifier'; window.scrollTo({ top: 0, behavior: 'smooth' }); } }
        async function annuler(id) { if (!confirm('Annuler cette réservation ?')) return; const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' }); if (response.ok) { afficherMessage('Réservation annulée', 'success'); chargerReservations(); } }
        async function confirmer(id) { const response = await fetch(`${API_BASE}/${id}/confirmer`, { method: 'POST' }); if (response.ok) { afficherMessage('Réservation confirmée', 'success'); chargerReservations(); } }
        async function checkIn(id) { const response = await fetch(`${API_BASE}/${id}/checkin`, { method: 'POST' }); if (response.ok) { afficherMessage('Check-in effectué', 'success'); chargerReservations(); } }
        async function checkOut(id) { const response = await fetch(`${API_BASE}/${id}/checkout`, { method: 'POST' }); if (response.ok) { afficherMessage('Check-out effectué', 'success'); chargerReservations(); } }
        function resetForm() { document.getElementById('reservationForm').reset(); document.getElementById('reservationId').value = ''; document.getElementById('formTitle').textContent = 'Nouvelle réservation'; document.getElementById('submitBtn').textContent = 'Créer'; }
    </script>
</body>
</html>
