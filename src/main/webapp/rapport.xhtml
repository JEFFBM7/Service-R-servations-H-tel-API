<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rapport - Service Hôtel</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
</head>
<body>
    <header class="header">
        <h1>Rapport</h1>
        <nav class="nav">
            <a href="index.xhtml">Accueil</a>
            <a href="reservations.xhtml">Réservations</a>
            <a href="disponibilite.xhtml">Disponibilité</a>
            <a href="clients.xhtml">Clients</a>
            <a href="rapport.xhtml" class="active">Rapport</a>
        </nav>
    </header>
    <div class="container">
        <div class="toolbar">
            <div class="toolbar-date" id="dateGeneration">—</div>
            <div>
                <button type="button" class="btn btn-primary" onclick="genererRapport()">Actualiser</button>
                <button type="button" class="btn btn-secondary" onclick="window.print()">Imprimer</button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">Total réservations</div>
                <div class="stat-value" id="total">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Occupations actuelles</div>
                <div class="stat-value" id="occupations">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">À venir</div>
                <div class="stat-value" id="avenir">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Annulées</div>
                <div class="stat-value" id="annulees">—</div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Répartition</div>
            <div class="chart" id="chart">
                <div class="bar-group">
                    <div class="bar" id="bar1" style="height: 0;"></div>
                    <div class="bar-label">Occupations</div>
                    <div class="bar-value" id="bar1-val">0</div>
                </div>
                <div class="bar-group">
                    <div class="bar" id="bar2" style="height: 0;"></div>
                    <div class="bar-label">À venir</div>
                    <div class="bar-value" id="bar2-val">0</div>
                </div>
                <div class="bar-group">
                    <div class="bar" id="bar3" style="height: 0;"></div>
                    <div class="bar-label">Annulées</div>
                    <div class="bar-value" id="bar3-val">0</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Occupations actuelles</div>
            <div id="occupationsTable"></div>
        </div>
        <div class="card">
            <div class="card-title">Réservations à venir</div>
            <div id="avenirTable"></div>
        </div>
    </div>
    <script type="text/javascript">
    //<![CDATA[
        var API_BASE = 'api/reservations';
        document.addEventListener('DOMContentLoaded', genererRapport);
        async function genererRapport() {
            try { 
                var response = await fetch(API_BASE + '/rapport'); 
                var data = await response.json(); 
                afficherRapport(data); 
            }
            catch (e) { 
                afficherRapport({ totalReservations: 0, occupationsActuelles: 0, reservationsAVenir: 0, reservationsAnnulees: 0, listeOccupationsActuelles: [], listeReservationsAVenir: [], dateGeneration: new Date().toLocaleString('fr-FR') }); 
            }
        }
        function afficherRapport(data) {
            document.getElementById('dateGeneration').textContent = 'Généré le ' + (data.dateGeneration || new Date().toLocaleString('fr-FR'));
            document.getElementById('total').textContent = data.totalReservations || 0;
            document.getElementById('occupations').textContent = data.occupationsActuelles || 0;
            document.getElementById('avenir').textContent = data.reservationsAVenir || 0;
            document.getElementById('annulees').textContent = data.reservationsAnnulees || 0;
            var max = Math.max(data.occupationsActuelles || 0, data.reservationsAVenir || 0, data.reservationsAnnulees || 0, 1);
            var maxH = 100;
            document.getElementById('bar1').style.height = ((data.occupationsActuelles || 0) / max * maxH) + 'px';
            document.getElementById('bar1').className = 'bar' + (data.occupationsActuelles > 0 ? ' active' : '');
            document.getElementById('bar1-val').textContent = data.occupationsActuelles || 0;
            document.getElementById('bar2').style.height = ((data.reservationsAVenir || 0) / max * maxH) + 'px';
            document.getElementById('bar2').className = 'bar' + (data.reservationsAVenir > 0 ? ' active' : '');
            document.getElementById('bar2-val').textContent = data.reservationsAVenir || 0;
            document.getElementById('bar3').style.height = ((data.reservationsAnnulees || 0) / max * maxH) + 'px';
            document.getElementById('bar3-val').textContent = data.reservationsAnnulees || 0;
            document.getElementById('occupationsTable').innerHTML = data.listeOccupationsActuelles && data.listeOccupationsActuelles.length ? renderTable(data.listeOccupationsActuelles, 'active') : '<div class="empty">Aucune occupation en cours</div>';
            document.getElementById('avenirTable').innerHTML = data.listeReservationsAVenir && data.listeReservationsAVenir.length ? renderTable(data.listeReservationsAVenir, 'confirmed') : '<div class="empty">Aucune réservation à venir</div>';
        }
        function renderTable(reservations, badgeType) {
            var html = '<table><thead><tr><th>ID</th><th>Client</th><th>Chambre</th><th>Arrivée</th><th>Départ</th><th>Montant</th><th>Statut</th></tr></thead><tbody>';
            for (var i = 0; i < reservations.length; i++) {
                var r = reservations[i];
                html += '<tr><td>#' + r.id + '</td><td>' + (r.nomClient || 'Client ' + r.clientId) + '</td><td>' + (r.numeroChambre || r.chambreId) + '</td><td>' + r.dateDebut + '</td><td>' + r.dateFin + '</td><td>' + (r.montantTotal ? r.montantTotal.toFixed(2) + ' €' : '—') + '</td><td><span class="badge badge-' + badgeType + '">' + r.statut + '</span></td></tr>';
            }
            html += '</tbody></table>';
            return html;
        }
    //]]>
    </script>
</body>
</html>
